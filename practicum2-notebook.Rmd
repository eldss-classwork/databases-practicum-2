---
title: "CS5200 Fall 2020: Practicum 2"
author: "Chandra Davis, Evan Douglass"
output:
  pdf_document: default
---

## Overview

We've decided to work with SQLite for this practicum. As such, to work with these files you will need SQLite installed on your machine. The data we are using is provided by IMDB at https://datasets.imdbws.com/

Download all the compressed tsv files into a folder called `data/`. You can leave them in their compressed format, as that is how we will read them in to this notebook.

## Setup

Before working with the data we need to create a place to store it. This section will set up any constants needed later and connect to a SQLite database.

```{r}
# Setup SQLite database
library(RSQLite)
DB_NAME <- "imdb-data.db"
conn <- dbConnect(RSQLite::SQLite(), DB_NAME)
```


<!-- 
    Reading everything at once is too much data. Basically crashed my computer.
    We'll have to come up with a more efficient way to read data when we need it
    and remove it from memory when we don't.
-->
!!!Need to download the files from the web before completing the next chunk!!!
Files were manually downloaded and saved to the data folder for testing

```{r}
# Simplify data extraction for later
getAkasData <- function() {
  read.table("data/title.akas.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getNameBasicsData <- function() {
  read.table("data/name.basics.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getTitleBasicsData <- function() {
  read.table("data/title.basics.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getCrewData <- function() {
  read.table("data/title.crew.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getEpisodeData <- function() {
 read.table("data/title.episode.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getPrincipalsData <- function() {
  read.table("data/title.principals.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}

getRatingsData <- function() {
  read.table("data/title.ratings.tsv.gz", sep='\t', fill=TRUE, header=TRUE, encoding="UTF-8")
}
```

The following chunk creates the database schema using CREATE TABLE statements. This schema was designed for the relational model based on the above datasets.

```{r}
# First we need to remove any existing data,
# for example, if this has been run before.
drop_sql <- function(table_name) {
  paste("DROP TABLE IF EXISTS ", table_name, ";", sep="")
}

dbExecute(conn, "PRAGMA foreign_keys = OFF;") # Avoid FK check constraints
curr_tables <- dbListTables(conn)
for (table in curr_tables) {
  dbExecute(conn, drop_sql(table))
}
dbExecute(conn, "PRAGMA foreign_keys = ON;")

# Then we can create the tables
CREATE <- "CREATE TABLE IF NOT EXISTS"
tables <- c(
  paste(
    CREATE, "Title_Type (
      format_id INTEGER PRIMARY KEY,
      format TEXT NOT NULL
    );"
  ),
  paste(
    CREATE, "Media (
      tconst TEXT PRIMARY KEY,
      format_id INTEGER NOT NULL,
      primaryTitle TEXT,
      originalTitle TEXT,
      isAdult 
    );"
  ),
)
dbExecute(conn, test1)
```

